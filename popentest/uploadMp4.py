import time
import sys
import json
import redis
import os
#from testlib import MyObsClient

def uploadMp4File(mp4RemotePath, mp4LocalPath):
    print("upload file")
    print(mp4LocalPath)
    endpoint = "http://gqjt.com"
    bucket = "x8v-drivingcloud-xtest"
    ak = "CB350C40B87AA1F98EC4"
    sk = "po31sdnqhaYU6xV3Y2daLNHruxMAAAGEuHqh+fPl"
    #client = MyObsClient(sk=sk, ak=ak, server=endpoint)
    #obsKey = "matlab"
    obsKey = mp4RemotePath
    #client.put_file(bucket, obsKey, mp4LocalPath)

# json
def mp4ValStr(path, mile, xosc_id):
    dict_data = {}
    dict_data['mp4path'] = path
    dict_data['mile'] = mile
    dict_data['xosc_id'] = xosc_id
    dict_data_str = json.dumps(dict_data)
    return dict_data_str

def insertRecordToRedis(uuid, mile, xosc_id, mp4RemotePath):
    print("insert record to redis")
    data = mp4ValStr(mp4RemotePath, mile, xosc_id)
    print(data)
    #redisapp = redis.ConnectionPool('127.0.0.1',6379,password='123456',decode_responses=True)
    #redishandle = redis.Redis(connection_pool=redisapp)
    redishandle = redis.Redis(host='127.0.0.1',port=6379,password='123456')
    mp4Key = "task_mp4_" + uuid
    redishandle.rpush(mp4Key, data)

if __name__ == "__main__":
    print(sys.argv[1:])
    ab = sys.argv[1:]
    length = len(ab)
    print(length)

    if length == 4:
        uuid = sys.argv[1]
        mile = sys.argv[2]
        xoscPath = sys.argv[3]
        mp4LocalPath = sys.argv[4]
        mp4Name = os.path.basename(mp4LocalPath)
        xosc_id = os.path.basename(xoscPath)
        mp4RemotePath = 'saimo/mp4/' + uuid + '/' + mp4Name
        #uploadMp4File(mp4RemotePath, mp4LocalPath)
        insertRecordToRedis(uuid, mile, xosc_id, mp4RemotePath)

    sys.exit(0)


